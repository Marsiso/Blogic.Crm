@using static Blogic.Crm.Infrastructure.Sorting.ConsultantSortOrder
@using Humanizer
@using Microsoft.AspNetCore.Mvc.TagHelpers
@using Blogic.Crm.Web.Controllers
@model Blogic.Crm.Web.Views.Consultant.GetConsultantsViewModel

@{
    ViewData["Title"] = "Consultant Dashboard";

    Dictionary<string, string> queryStringBase = new()
    {
        { nameof(Model.QueryString.SearchString), Model.QueryString.SearchString },
        { nameof(Model.QueryString.SortOrder), Model.QueryString.SortOrder.ToString() },
        { nameof(Model.QueryString.PageSize), Model.QueryString.PageSize.ToString() }
    };

    Dictionary<string, string> currentPageQueryString = new(queryStringBase)
    {
        [nameof(Model.QueryString.PageNumber)] = Model.Consultants.CurrentPage.ToString()
    };

    Dictionary<string, string> previousPageQueryString = new(queryStringBase)
    {
        [nameof(Model.QueryString.PageNumber)] = (Model.Consultants.CurrentPage - 1).ToString()
    };

    Dictionary<string, string> nextPageQueryString = new(queryStringBase)
    {
        [nameof(Model.QueryString.PageNumber)] = (Model.Consultants.CurrentPage + 1).ToString()
    };

    Dictionary<string, string> firstPageQueryString = new(queryStringBase)
    {
        [nameof(Model.QueryString.PageNumber)] = MinimumPageNumber.ToString()
    };

    Dictionary<string, string> lastPageQueryString = new(queryStringBase)
    {
        [nameof(Model.QueryString.PageNumber)] = Model.Consultants.TotalPages.ToString()
    };

    var hasPrevListItemClass = $"page-item {(Model.Consultants.HasPrevious ? string.Empty : "disabled")}";
    var hasPrevLinkClass = $"btn page-link {(Model.Consultants.HasPrevious ? string.Empty : "disabled")}";
    var prevPage = (Model.Consultants.CurrentPage - 1).ToString();

    var hasNextListItemClass = $"page-item {(Model.Consultants.HasNext ? string.Empty : "disabled")}";
    var hasNextLinkClass = $"btn page-link {(Model.Consultants.HasNext ? string.Empty : "disabled")}";
    var nextPage = (Model.Consultants.CurrentPage + 1).ToString();
}

<h1 class="mt-4">Dashboard</h1>

<h2>Consultant</h2>
<div class="mb-5">
    <a asp-action="CreateConsultant"
       class="btn btn-primary">
        Create
    </a>
</div>

<h2>Filters</h2>
<form asp-action="GetConsultants" method="@HttpMethods.Post" class="mb-5">
    <div class="mb-3">
        <label class="form-label"
               asp-for="@Model.QueryString.SearchString">
            Search
        </label>
        <input type="text"
               class="form-control"
               asp-for="@Model.QueryString.SearchString">
        <div asp-for="@Model.QueryString.SearchString" class="form-text">Search consultants.</div>
    </div>
    <div class="mb-3">
        <label asp-for="@Model.QueryString.PageSize"
               class="form-label">
            @($"Page Size: \t {Model.Consultants.PageSize.ToString()}")
        </label>
        <input type="range"
               class="form-range"
               min="@MinimumPageSize.ToString()"
               max="@MaximumPageSize.ToString()"
               asp-for="@Model.QueryString.PageSize">
        <div asp-for="@Model.QueryString.PageSize" class="form-text">Number of displayed consultants.</div>
    </div>
    <div class="mb-3">
        <label class="form-label"
               asp-for="@Model.QueryString.SortOrder">
            Order by
        </label>
        <select class="form-select" asp-for="@Model.QueryString.SortOrder">
            <option selected value="@Id">@Id.Humanize()</option>
            <option value="@IdDesc">@IdDesc.Humanize()</option>
            <option value="@Email">@Email.Humanize()</option>
            <option value="@EmailDesc">@EmailDesc.Humanize()</option>
            <option value="@GivenName">@GivenName.Humanize()</option>
            <option value="@GivenNameDesc">@GivenNameDesc.Humanize()</option>
            <option value="@FamilyName">@FamilyName.Humanize()</option>
            <option value="@FamilyNameDesc">@FamilyNameDesc.Humanize()</option>
            <option value="@Phone">@Phone.Humanize()</option>
            <option value="@PhoneDesc">@PhoneDesc.Humanize()</option>
            <option value="@DateBorn">@DateBorn.Humanize()</option>
            <option value="@DateBornDesc">@DateBornDesc.Humanize()</option>
            <option value="@BirthNumber">@BirthNumber.Humanize()</option>
            <option value="@BirthNumberDesc">@BirthNumberDesc.Humanize()</option>
        </select>
    </div>
    <button class="btn btn-primary" type="submit">Filter</button>
</form>

<h2>Export</h2>
<form asp-action="ExportConsultants"
      method="@HttpMethods.Post"
      asp-all-route-data="@currentPageQueryString"
      class="mb-5">
    <button class="btn btn-primary" type="submit">CSV</button>
</form>

<h2>Consultants</h2>
<div class="table-responsive">
    <table class="table table-hover table-sm">
        <caption>@Model.Consultants.TotalItems.ToString() Matches</caption>
        <thead>
        <tr>
            <th scope="col">
                @nameof(Consultant.Id).Humanize()
            </th>
            <th scope="col">
                @nameof(Consultant.Email).Humanize()
            </th>
            <th scope="col">
                @nameof(Consultant.GivenName).Humanize()
            </th>
            <th scope="col">
                @nameof(Consultant.FamilyName).Humanize()
            </th>
            <th scope="col">
                @nameof(Consultant.Phone).Humanize()
            </th>
            <th scope="col">
                @nameof(Consultant.DateBorn).Humanize()
            </th>
            <th scope="col">
                @nameof(Consultant.BirthNumber).Humanize()
            </th>
            <th scope="col">
                Manage
            </th>
        </tr>
        </thead>
        <tbody>
        @foreach (var consultant in Model.Consultants)
        {
            <tr>
                <td class="pe-5">@consultant.Id</td>
                <td class="pe-5">
                    @consultant.Email
                    <br/>
                    @consultant.NormalizedEmail
                </td>
                <td class="pe-5">@consultant.GivenName</td>
                <td class="pe-5">@consultant.FamilyName</td>
                <td class="pe-5">@consultant.Phone</td>
                <td class="pe-5">
                    @consultant.DateBorn.ToString("dd/MM/yyyy")
                    <br>
                    @consultant.DateBorn.Humanize()
                </td>
                <td class="pe-5">@($"{consultant.BirthNumber[..6]}/{consultant.BirthNumber[6..]}")</td>
                <td>
                    <div class="d-flex justify-content-start align-items-center">
                        <a asp-route-id="@consultant.Id.ToString()"
                           asp-action="GetConsultant"
                           class="btn btn-primary text-decoration-none me-1">
                            Detail
                        </a>
                        <a asp-route-id="@consultant.Id.ToString()"
                           asp-action="UpdateConsultant"
                           asp-route-originAction="@nameof(ConsultantController.GetConsultants)"
                           class="btn btn-warning text-decoration-none me-1">
                            Update
                        </a>
                        <a asp-route-id="@consultant.Id.ToString()"
                           asp-action="DeleteConsultantPrompt"
                           asp-route-originAction="@nameof(ConsultantController.GetConsultants)"
                           class="btn btn-danger text-decoration-none">
                            Delete
                        </a>
                    </div>
                </td>
            </tr>
        }
        </tbody>
    </table>
</div>

<div class="row">
    <div class="col-4"></div>
    <div class="col-4">
        <div class="d-flex justify-content-center align-items-center">
            <nav aria-label="Page navigation example">
                <ul class="pagination">
                    <li class="@hasPrevListItemClass">
                        <a type="submit"
                           class="@hasPrevLinkClass"
                           asp-controller="Consultant"
                           asp-action="GetConsultants"
                           asp-all-route-data="@firstPageQueryString">
                            First
                        </a>
                    </li>
                    <li class="@hasPrevListItemClass">
                        <a type="submit"
                           class="@hasPrevLinkClass"
                           asp-controller="Consultant"
                           asp-action="GetConsultants"
                           asp-all-route-data="@previousPageQueryString">
                            Prev
                        </a>
                    </li>
                    @if (Model.Consultants.HasPrevious)
                    {
                        <li class="page-item">
                            <a type="submit"
                               class="page-link"
                               asp-controller="Consultant"
                               asp-action="GetConsultants"
                               asp-all-route-data="@previousPageQueryString">
                                @prevPage
                            </a>
                        </li>
                    }
                    <li class="page-item active">
                        <a class="page-link"
                           type="submit"
                           asp-controller="Consultant"
                           asp-action="GetConsultants"
                           asp-all-route-data="@currentPageQueryString">
                            @Model.Consultants.CurrentPage.ToString()
                        </a>
                    </li>

                    @if (Model.Consultants.HasNext)
                    {
                        <li class="page-item">
                            <a type="submit"
                               class="page-link"
                               asp-controller="Consultant"
                               asp-action="GetConsultants"
                               asp-all-route-data="@nextPageQueryString">
                                @nextPage
                            </a>
                        </li>
                    }
                    <li class="@hasNextListItemClass">
                        <a type="submit"
                           class="@hasNextLinkClass"
                           asp-controller="Consultant"
                           asp-action="GetConsultants"
                           asp-all-route-data="@nextPageQueryString">
                            Next
                        </a>
                    </li>
                    <li class="@hasNextListItemClass">
                        <a class="@hasNextLinkClass"
                           asp-controller="Consultant"
                           asp-action="GetConsultants"
                           asp-all-route-data="@lastPageQueryString">
                            Last
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
    <div class="col-4"></div>
</div>